@page "/admin/kalenders/myagenda"
@using Services.Core;
@using Shared.DTO.Core;
@inject NavigationManager NavManager
@using Models
@inject TimeSlotService timeSlotService
@inject DoctorService doctorService
@inject AppointmentService appointmentService
@using Syncfusion.Blazor.Schedule
@using BlazorApp.Components.Modals;
@attribute [Authorize(Roles = "Admin, Employee")]


<div class="sidebar">
    <SideNavMenu />
</div>
<div class="content">
    <div class="agenda-container">
            <h1>Agenda</h1>
            <Select TValue="int?" SelectedValue="@SelectedDoctor" SelectedValueChanged="@OnSelectedValueChanged">
            @if(Doctors != null) {
                @foreach (var doctor in Doctors)
                {
                    <SelectItem TValue="int?" Value="@doctor.Id">@doctor.Name</SelectItem>
                }
            }
            </Select>
            <SfSchedule TValue="AppointmentData" AllowDragAndDrop="false" @ref="@ScheduleRef" @bind-SelectedDate="@CurrentDate" >
                <ScheduleEvents TValue="AppointmentData" OnEventClick="OnEventClick"></ScheduleEvents>
                <ScheduleEventSettings DataSource="@DataSource">
                    <Template>
                        <AppointmentPopup Context="context" OnDeleteAppointment="CancelAppointment" />
                    </Template>
                </ScheduleEventSettings>
                <ScheduleTimeScale Enable="true" SlotCount="1" Interval="15"></ScheduleTimeScale>
                <ScheduleViews>
                    <ScheduleView Option="View.Day" StartHour="07:00" EndHour="20:00"></ScheduleView>
                    <ScheduleView Option="View.Week" StartHour="07:00" EndHour="20:00" FirstDayOfWeek="1"></ScheduleView>
                    <ScheduleView Option="View.WorkWeek" StartHour="07:00" EndHour="20:00"></ScheduleView>
                    <ScheduleView Option="View.Month" StartHour="07:00" EndHour="20:00"></ScheduleView>
                    <ScheduleView Option="View.Agenda" StartHour="07:00" EndHour="20:00"></ScheduleView>
                </ScheduleViews>
            </SfSchedule>
    </div>
</div>

@code {

    SfSchedule<AppointmentData> ScheduleRef;

    private IEnumerable<TimeSlotDTO> TimeSlots { get; set; }

    private IEnumerable<TimeSlotDTO> TimeSlotsByWeek { get; set; }

    private DateTime currentWeekStart = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek).AddDays(1);
    private DateTime currentWeekEnd = DateTime.Today.AddDays(-(int)DateTime.Today.DayOfWeek).AddDays(7);

    private DateTime CurrentDate = DateTime.Now;
    private List<AppointmentData> DataSource { get; set; }
    private IEnumerable<DoctorDTO> Doctors { get; set; }
    private int SelectedDoctor { get; set; }
    View CurrentView = View.Week;

    public async Task OnEventClick(EventClickArgs<AppointmentData> args)
    {
        args.Cancel = true;
        CurrentAction action = CurrentAction.Save;
        
        await ScheduleRef.OpenEditorAsync(args.Event, action); //to open the editor window on event click
    }

    private AppointmentData MapToAppointmentData(TimeSlotDTO timeSlot)
    {
        AppointmentData appointmentData = new AppointmentData
        {
            Id = (int)timeSlot.Id,
            StartTime = timeSlot.DateTime,
            EndTime = timeSlot.DateTime.AddMinutes(timeSlot.Duration),
            TimeSlotDTO = timeSlot
        };

        if(timeSlot.AppointmentDTO != null)
        {
            appointmentData.Subject = timeSlot.AppointmentDTO.PatientDTO.Name;
            appointmentData.CssClass = "occupied";
            appointmentData.AppointmentDTO = timeSlot.AppointmentDTO;
        }
        else
        {
            appointmentData.Subject = "Beschikbaar";
            appointmentData.CssClass = "available";
        }

        return appointmentData;
    }

    private async Task LoadTimeSlots(int doctorId)
    {
        TimeSlots = await timeSlotService.GetTimeSlots(SelectedDoctor);
        DataSource.Clear();
        DataSource = TimeSlots.Select(MapToAppointmentData).ToList();
        CurrentDate = DateTime.Now;
    }

    private async Task OnSelectedValueChanged(int? value)
    {
        SelectedDoctor = (int)value;
        await LoadTimeSlots(SelectedDoctor);
    }

    protected override async Task OnInitializedAsync()
    {
        DataSource = new List<AppointmentData>();
        Doctors = await doctorService.GetDoctors();
        SelectedDoctor = (int)Doctors.FirstOrDefault().Id;
        await LoadTimeSlots(SelectedDoctor);
    }

    protected async Task CancelAppointment(int id)
    {
        TimeSlotDTO timeSlot = TimeSlots.FirstOrDefault(ts => ts.Id == id);
        await appointmentService.DeleteAppointment(timeSlot.AppointmentDTO);
        timeSlot.AppointmentDTO = null;
        await timeSlotService.UpdateTimeSlot(timeSlot, SelectedDoctor);
        DataSource.Remove(DataSource.FirstOrDefault(ds => ds.Id == id));
    }
}

<style>
    .e-schedule .e-vertical-view .e-all-day-appointment-wrapper .e-appointment.available,
    .e-schedule .e-vertical-view .e-day-wrapper .e-appointment.available,
    .e-schedule .e-month-view .e-appointment.available {
        background: rgba(79, 220, 76, 0.6);
        border-color: rgba(79, 220, 76, 0.6);
    }

    .e-schedule .e-vertical-view .e-all-day-appointment-wrapper .e-appointment.occupied,
    .e-schedule .e-vertical-view .e-day-wrapper .e-appointment.occupied,
    .e-schedule .e-month-view .e-appointment.occupied {
        background: #eb4d5b;
        border-color: #eb4d5b;
    }
</style>