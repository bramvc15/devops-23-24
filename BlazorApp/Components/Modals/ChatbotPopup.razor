@using Microsoft.JSInterop
@inject IJSRuntime JSRuntime
@using System.Text.Json
@using BlazorApp.Data
@using BlazorApp.Services
@using BlazorApp.Models
@using BlazorApp.Controllers
@inject DatabaseContext databaseContext
@using Microsoft.AspNetCore.Components
@inject ChatbotService ChatbotService

   <button class="btn" @onclick="ShowModal">@Text</button>
   <Modal @ref="modalRef">
    <ModalContent Centered>
        <ModalHeader>
            <ModalTitle>Vraag toevoegen</ModalTitle>
            <CloseButton />
        </ModalHeader>
        <ModalBody>
            <Field>
                <FieldLabel>Vraag</FieldLabel>
                <TextEdit Placeholder="Vraag die de bezoeker aanklikt" @bind-Text="question" />
            </Field>
            <Field>
                <FieldLabel>Antwoord</FieldLabel>
                <TextEdit Placeholder="Antwoord die de chatbot geeft" @bind-Text="answer" />
            </Field>
        </ModalBody>
        <ModalFooter>
            <Button Color="Color.Secondary" >Sluit</Button>
            <Button Color="Color.Primary" Clicked="@AddQuestion">Voeg toe</Button>
        </ModalFooter>
    </ModalContent>
</Modal>

@code {
        [Parameter]
        public string Text { get; set; }

    private Modal? modalRef;

    string? question;
    string? answer;

    [Parameter]
    public ChatBotQuestion? ParentQuestion { get; set; }

    [Parameter]
    public EventCallback Refresh { get; set; }

    public void HandleRefresh() 
    {
        Refresh.InvokeAsync();
    }

    public async Task AddQuestion() 
    {
        if(this.question == null || this.answer == null || this.question == "" || this.answer == "") 
            return;

        ChatBotQuestion question = new ChatBotQuestion();
        question.Question = this.question;
        question.Answer = this.answer;

        if(ParentQuestion != null)
            ChatbotService.AddFollowUpQuestion(ParentQuestion, question);
        else
            await ChatbotService.AddQuestion(question);
        
        modalRef?.Hide();
        this.question = null;
        this.answer = null;

        HandleRefresh();
    }

    private Task? ShowModal()
    {
        return modalRef?.Show();
    }
}